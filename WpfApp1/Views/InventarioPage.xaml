<Page x:Class="OrySiPOS.Views.InventarioPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:OrySiPOS.Views"
      xmlns:vm="clr-namespace:OrySiPOS.ViewModels"
      mc:Ignorable="d" 
      d:DesignHeight="600" d:DesignWidth="900"
      Title="InventarioPage"
      Background="{StaticResource PageBackground}"
      d:DataContext="{d:DesignInstance Type=vm:InventarioViewModel, IsDesignTimeCreatable=False}">

    <Page.Resources>
        <ContextMenu x:Key="MenuAccionesProducto">
            <MenuItem Header="Editar Producto" Click="EditarProducto_Click"/>
            <MenuItem Header="Ver detalles" Click="VerDetalles_Click"/>
            <MenuItem Header="Historial de movimientos" Click="Historial_Click"/>
            <Separator/>
            <MenuItem Click="Deshabilitar_Click">
                <MenuItem.Style>
                    <Style TargetType="MenuItem">
                        <Setter Property="Header" Value="Deshabilitar"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Activo}" Value="False">
                                <Setter Property="Header" Value="Habilitar"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </MenuItem.Style>
            </MenuItem>
        </ContextMenu>
    </Page.Resources>

    <Grid Margin="30">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0">
            <Grid Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Inventario" FontSize="28" FontWeight="Bold" Foreground="{StaticResource TextPrimary}"/>
                    <TextBlock Text="Gestión general de productos" FontSize="14" Foreground="{StaticResource SecondaryColor}"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="Importar CSV" Click="BtnImportar_Click" Margin="0,0,10,0" Style="{StaticResource BtnSecondary}"/>
                    <Button Content="Exportar CSV" Click="BtnExportar_Click" Margin="0,0,10,0" Style="{StaticResource BtnSecondary}"/>

                    <Button Content="Importar XML" Click="BtnImportarXML_Click" Margin="0,0,10,0" Style="{StaticResource BtnWarning}"/>

                    <Button Content="📧 Importar Email" Click="BtnEscanearCorreo_Click" Margin="0,0,10,0"/>

                    <Button Content="+ Nuevo" Command="{Binding NuevoProductoCommand}" Style="{StaticResource BtnSuccess}"/>
                </StackPanel>
            </Grid>

            <Border Background="{StaticResource SurfaceBrush}" 
        CornerRadius="8" 
        Padding="20,20,20,10" 
        Margin="0,0,0,20"
        BorderBrush="{StaticResource BorderBrush}"
        BorderThickness="1">

                <WrapPanel Orientation="Horizontal" VerticalAlignment="Center">

                    <Grid VerticalAlignment="Center" Margin="0,0,15,10">
                        <TextBox x:Name="SearchTextBox" Width="280"
                     Text="{Binding TextoBusqueda, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                     GotFocus="SearchTextBox_GotFocus" 
                     LostFocus="SearchTextBox_LostFocus"/>
                    </Grid>

                    <ComboBox Width="170" 
                  ItemsSource="{Binding CategoriasDisponibles}" 
                  SelectedItem="{Binding CategoriaSeleccionada}" 
                  DisplayMemberPath="Nombre" 
                  Margin="0,0,10,10"/>

                    <ComboBox Width="170" 
                  ItemsSource="{Binding SubcategoriasDisponibles}" 
                  SelectedItem="{Binding SubcategoriaSeleccionada}" 
                  DisplayMemberPath="Nombre"
                  Margin="0,0,20,10"/>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,20,10">
                        <CheckBox x:Name="ChkActivos" 
                      Content="Activos" 
                      IsChecked="{Binding VerActivos}" 
                      Margin="0,0,15,0"/>

                        <CheckBox x:Name="ChkBajoStock" 
                      Content="Bajo Stock" 
                      IsChecked="{Binding VerBajoStock}" 
                      Foreground="{StaticResource WarningColor}"
                      FontWeight="SemiBold"/>
                    </StackPanel>

                    <Button Content="Limpiar filtros" 
                Command="{Binding LimpiarFiltrosCommand}" 
                Style="{StaticResource BtnSecondary}" 
                Height="38"
                Margin="0,0,0,10"/>
                </WrapPanel>
            </Border>
        </StackPanel>

        <DataGrid Grid.Row="1" x:Name="GridProductos" 
                  ItemsSource="{Binding Productos}"
                  MouseDoubleClick="GridProductos_MouseDoubleClick">

            <DataGrid.RowStyle>
                <Style TargetType="DataGridRow" BasedOn="{StaticResource {x:Type DataGridRow}}">
                    <Setter Property="ContextMenu" Value="{StaticResource MenuAccionesProducto}"/>
                </Style>
            </DataGrid.RowStyle>

            <DataGrid.Columns>
                <DataGridTextColumn Header="SKU" Binding="{Binding ID}" Width="80">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Center"/>
                            <Setter Property="VerticalAlignment" Value="Center"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>

                <DataGridTemplateColumn Header="Imagen" Width="60">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Image Source="{Binding ImagenUrl}" Height="35" HorizontalAlignment="Center"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTextColumn Header="Descripción" Binding="{Binding Descripcion}" Width="*"/>

                <DataGridTextColumn Header="Precio" Binding="{Binding Precio, StringFormat=C}" Width="100" FontWeight="Bold"/>
                <DataGridTextColumn Header="Stock" Binding="{Binding Stock}" Width="80"/>

                <DataGridTemplateColumn Header="Estado" Width="100">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Border CornerRadius="4" Padding="5,2" HorizontalAlignment="Center">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="#D4EDDA"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Activo}" Value="False">
                                                <Setter Property="Background" Value="#F8D7DA"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock FontWeight="SemiBold" FontSize="11">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Text" Value="ACTIVO"/>
                                            <Setter Property="Foreground" Value="#155724"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Activo}" Value="False">
                                                    <Setter Property="Text" Value="INACTIVO"/>
                                                    <Setter Property="Foreground" Value="#721C24"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Border>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>

                <DataGridTemplateColumn Header="Acciones" Width="120">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <Button Content="+" Width="30" Height="30" Padding="0" Margin="2" 
                                        ToolTip="Añadir Stock" Click="AddStock_Click" Style="{StaticResource BtnSuccess}"/>
                                <Button Content="-" Width="30" Height="30" Padding="0" Margin="2" 
                                        ToolTip="Quitar Stock" Click="RemoveStock_Click" Style="{StaticResource BtnWarning}"/>
                                <Button Content="..." Width="30" Height="30" Padding="0" Margin="2" 
                                        ToolTip="Opciones" Click="OpcionesButton_Click" ContextMenu="{StaticResource MenuAccionesProducto}" Style="{StaticResource BtnSecondary}"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <Border Grid.Row="2" 
        Background="#E9ECEF" 
        BorderBrush="{StaticResource BorderBrush}" 
        BorderThickness="0,1,0,0" 
        Padding="15,5" 
        Margin="0,10,0,0"
        CornerRadius="0,0,8,8">

            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <TextBlock Text="Total de registros:" 
                   FontWeight="SemiBold" 
                   Foreground="{StaticResource TextSecondary}" 
                   Margin="0,0,5,0"/>

                <TextBlock Text="{Binding TotalProductos}" 
                   FontWeight="Bold" 
                   Foreground="{StaticResource PrimaryColor}"/>
            </StackPanel>
        </Border>
    </Grid>
</Page>